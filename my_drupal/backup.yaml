--- #NFS
apiVersion: v1
kind: PersistentVolume
metadata:
  name: drupal-backup-data-pv
spec:
  storageClassName: drupal-backup-data
  capacity:
    storage: 512Gi
  accessModes:
    - ReadWriteOnce
  volumeMode: Filesystem
  persistentVolumeReclaimPolicy: Retain
  nfs:
    server: atsushi.local
    path: /mnt/backup/drupal
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: drupal-backup-data-pv-claim
  labels:
    app: my-drupal
spec:
  storageClassName: drupal-backup-data
  accessModes:
    - ReadWriteOnce
  volumeMode: Filesystem
  resources:
    requests:
      storage: 512Gi
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-script
data:
  backup.sh: |
    #!/bin/bash

    apt-get -y update
    apt-get -y upgrade
    apt-get -y autopurge
    apt-get -y install rsync
    apt-get -y autoclean

    echo "#####################################################"
    echo "-->  Data Backup !!"

    # Data
    DATADIR="/mnt/data"       #バックアップ元の親ディレクトリ
    BASEDIR="/mnt/backupData" #バックアップ先の親ディレクトリ
    LATESTBKUP=$(ls $BASEDIR | grep backup- | tail -n 1) #直近のバックアップのディレクトリ名
    rsync -Aaxh --link-dest="$BASEDIR/$LATESTBKUP" "$DATADIR/" "$BASEDIR/backup-$(date +%Y%m%d-%H%M%S)"
    # rsync -Aavxh --link-dest="$BASEDIR/$LATESTBKUP" "$DATADIR/" "$BASEDIR/backup-$(date +%Y%m%d-%H%M%S)"

    echo "#####################################################"
    echo "-->  DB Backup !!"

    # DB
    DATADIR="/mnt/db"       #バックアップ元の親ディレクトリ
    BASEDIR="/mnt/backupDb" #バックアップ先の親ディレクトリ
    LATESTBKUP=$(ls $BASEDIR | grep backup- | tail -n 1) #直近のバックアップのディレクトリ名
    rsync -Aaxh --link-dest="$BASEDIR/$LATESTBKUP" "$DATADIR/" "$BASEDIR/backup-$(date +%Y%m%d-%H%M%S)"
    # rsync -Aavxh --link-dest="$BASEDIR/$LATESTBKUP" "$DATADIR/" "$BASEDIR/backup-$(date +%Y%m%d-%H%M%S)"

    echo "#####################################################"

    echo "Backup Finish!"

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: drupal-backup-cronjob
  labels:
    app: my-drupal
spec:
  schedule: "0 3 * * *"
  timeZone: Asia/Tokyo
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: backup
              image: debian:12.11
              imagePullPolicy: IfNotPresent
              env:
                - name: TZ
                  value: Asia/Tokyo
              command:
                - bash
                - /usr/local/bin/backup.sh
              volumeMounts:
                - name: backup-script-file
                  mountPath: /usr/local/bin/
                #data
                - name: drupal-data-persistent-storage
                  mountPath: /mnt/data
                  subPath: data
                - name: drupal-data-persistent-storage
                  mountPath: /mnt/db
                  subPath: db
                #backup
                - name: backup-data-persistent-storage
                  mountPath: /mnt/backupData
                  subPath: data
                - name: backup-data-persistent-storage
                  mountPath: /mnt/backupDb
                  subPath: db
          restartPolicy: OnFailure
          volumes:
            - name: backup-script-file
              configMap:
                name: backup-script
            #data
            - name: drupal-data-persistent-storage
              persistentVolumeClaim:
                claimName: drupal-data-pv-claim
            #backup
            - name: backup-data-persistent-storage
              persistentVolumeClaim:
                claimName: drupal-backup-data-pv-claim
